version: '3.8'

services:
  telegram_claude_bot:
    build:
      # build context를 프로젝트 루트로 설정
      # pyproject.toml과 src/ 폴더가 루트에 있으므로 반드시 루트 기준이어야 함
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    image: telegram_claude_bot:latest
    container_name: telegram_claude_bot
    restart: unless-stopped

    # Docker 전용 고정 환경변수만 설정
    # 나머지 설정(TELEGRAM_BOT_TOKEN, NOTION_TOKEN 등)은
    # 볼륨 마운트된 .env 파일에서 앱(Pydantic Settings)이 직접 읽음
    # → .env 수정 후 docker restart 만으로 반영됨
    environment:
      - DATABASE_PATH=/app/data/.db/telegram_claude_bot.db
      - CLAUDE_CODE_PATH=claude

    volumes:
      # .env 파일 → 앱이 직접 읽음 (restart 시 새 값 반영)
      - ./.env:/app/.env:ro
      # DB 및 대화 이력 영속화
      - ./data:/app/data
      # Claude Code 작업 디렉토리
      - ./workspace:/app/workspace
      # 세션별 작업 디렉토리
      - ./sessions:/app/sessions
      # Claude CLI 인증 정보 영속화
      # .credentials.json 만 복사하면 인증 완료 (docker restart 로 반영)
      - ./claude_auth:/home/appuser/.claude

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
